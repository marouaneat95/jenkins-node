"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.default = ClientAttributesDecorationLayer;

var _inputValidation = _interopRequireDefault(require("./inputValidation"));

var _InMemory = _interopRequireDefault(require("../storage/AttributesCache/InMemory"));

var _attributes = require("../utils/inputValidation/attributes");

var _logger = _interopRequireDefault(require("../utils/logger"));

var _objectAssign = _interopRequireDefault(require("object-assign"));

var log = (0, _logger.default)('splitio-client');
/**
 * Add in memory attributes storage methods and combine them with any attribute received from the getTreatment/s call 
 */

function ClientAttributesDecorationLayer(context, isKeyBinded, isTTBinded) {
  var client = (0, _inputValidation.default)(context, isKeyBinded, isTTBinded);
  var attributeStorage = new _InMemory.default(); // Keep a reference to the original methods

  var clientGetTreatment = client.getTreatment;
  var clientGetTreatmentWithConfig = client.getTreatmentWithConfig;
  var clientGetTreatments = client.getTreatments;
  var clientGetTreatmentsWithConfig = client.getTreatmentsWithConfig;
  /**
   * Add an attribute to client's in memory attributes storage
   * 
   * @param {string} attributeName Attrinute name
   * @param {string, number, boolean, list} attributeValue Attribute value
   * @returns {boolean} true if the attribute was stored and false otherways
   */

  client.setAttribute = function (attributeName, attributeValue) {
    var attribute = {};
    attribute[attributeName] = attributeValue;
    if (!(0, _attributes.validateAttributesDeep)(attribute)) return false;
    log.debug("stored " + attributeValue + " for attribute " + attributeName);
    return attributeStorage.setAttribute(attributeName, attributeValue);
  };
  /**
   * Returns the attribute with the given key
   * 
   * @param {string} attributeName Attribute name
   * @returns {Object} Attribute with the given key
   */


  client.getAttribute = function (attributeName) {
    log.debug("retrieved attribute " + attributeName);
    return attributeStorage.getAttribute(attributeName + '');
  };
  /**
   * Add to client's in memory attributes storage the attributes in 'attributes'
   * 
   * @param {Object} attributes Object with attributes to store
   * @returns true if attributes were stored an false otherways
   */


  client.setAttributes = function (attributes) {
    if (!(0, _attributes.validateAttributesDeep)(attributes)) return false;
    return attributeStorage.setAttributes(attributes);
  };
  /**
   * Return all the attributes stored in client's in memory attributes storage
   * 
   * @returns {Object} returns all the stored attributes
   */


  client.getAttributes = function () {
    return attributeStorage.getAll();
  };
  /**
   * Removes from client's in memory attributes storage the attribute with the given key
   * 
   * @param {string} attributeName 
   * @returns {boolean} true if attribute was removed and false otherways
   */


  client.removeAttribute = function (attributeName) {
    log.debug("removed attribute " + attributeName);
    return attributeStorage.removeAttribute(attributeName + '');
  };
  /**
   * Remove all the stored attributes in the client's in memory attribute storage
   */


  client.clearAttributes = function () {
    return attributeStorage.clear();
  };

  client.getTreatment = function (maybeKey, maybeSplit, maybeAttributes) {
    return clientGetTreatment(maybeKey, maybeSplit, combineAttributes(maybeAttributes));
  };

  client.getTreatmentWithConfig = function (maybeKey, maybeSplit, maybeAttributes) {
    return clientGetTreatmentWithConfig(maybeKey, maybeSplit, combineAttributes(maybeAttributes));
  };

  client.getTreatments = function (maybeKey, maybeSplits, maybeAttributes) {
    return clientGetTreatments(maybeKey, maybeSplits, combineAttributes(maybeAttributes));
  };

  client.getTreatmentsWithConfig = function (maybeKey, maybeSplits, maybeAttributes) {
    return clientGetTreatmentsWithConfig(maybeKey, maybeSplits, combineAttributes(maybeAttributes));
  };

  function combineAttributes(maybeAttributes) {
    var storedAttributes = attributeStorage.getAll();

    if (Object.keys(storedAttributes).length > 0) {
      return (0, _objectAssign.default)({}, storedAttributes, maybeAttributes);
    }

    return maybeAttributes;
  }

  return client;
}